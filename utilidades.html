<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utilidades - ESI</title>
    <link rel="stylesheet" href="estilo.css">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; }
        
        #categoria-info { display: flex !important; }
        #menu { display: flex !important; }
        
        /* B√öSQUEDA */
        #search-container { 
            display: none !important; 
            flex-direction: column !important; 
            align-items: center !important; 
            padding: 20px !important; 
            width: 100% !important;
            padding-bottom: 100px !important;
        }
        #search-container h2 { color: #a267f5; margin-bottom: 20px; }
        #search-bar {
            width: 300px !important;
            padding: 12px !important;
            font-size: 16px !important;
            border: 1px solid #ccc !important;
            border-radius: 5px !important;
            margin-bottom: 10px !important;
        }
        #search-button {
            padding: 10px 30px !important;
            background: #a267f5 !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 16px !important;
        }
        #search-suggestions {
            margin: 20px 0 !important;
            display: flex !important;
            gap: 10px !important;
            flex-wrap: wrap !important;
            justify-content: center !important;
        }
        .search-suggestion {
            background: #ede9feff !important;
            color: #a267f5 !important;
            padding: 8px 15px !important;
            border: 1px solid #a267f5 !important;
            border-radius: 20px !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }
        .search-suggestion:hover {
            background: #a267f5 !important;
            color: white !important;
        }
        #search-results {
            display: none !important;
            width: 90% !important;
            max-width: 600px !important;
            margin-top: 20px !important;
        }
        #search-results table {
            width: 100% !important;
            border-collapse: collapse !important;
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        #search-results th {
            background: #a267f5 !important;
            color: white !important;
            padding: 12px !important;
            text-align: left !important;
        }
        #search-results td {
            border: 1px solid #ddd !important;
            padding: 12px !important;
        }
        .result-row {
            cursor: pointer !important;
        }
        .result-row:hover {
            background: #f5f5f5 !important;
        }
        .additional-info {
            background: #ede9feff !important;
        }

        /* INFOGRAF√çA */
        #pantallainfografia {
            display: none !important;
            flex-direction: column !important;
            align-items: center !important;
            padding: 20px !important;
            width: 100% !important;
            padding-bottom: 100px !important;
        }
        #pantallainfografia h2 { color: #a267f5; margin-bottom: 20px; }
        #grid-container {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)) !important;
            gap: 15px !important;
            width: 90% !important;
            max-width: 800px !important;
            margin: 20px auto !important;
        }
        .grid-item {
            position: relative !important;
            cursor: pointer !important;
            overflow: hidden !important;
            border-radius: 5px !important;
        }
        #grid-container img {
            width: 100% !important;
            height: 120px !important;
            object-fit: cover !important;
            display: block !important;
            transition: transform 0.3s !important;
        }
        .grid-item:hover img {
            transform: scale(1.1) !important;
        }
        #pagination-controls {
            display: flex !important;
            gap: 10px !important;
            margin: 20px !important;
            justify-content: center !important;
        }
        #pagination-controls button {
            padding: 10px 20px !important;
            background: #a267f5 !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
        }
        #pagination-controls button:disabled {
            background: #ccc !important;
            cursor: not-allowed !important;
        }

        /* CONTACTO */
        #message-container {
            display: none !important;
            flex-direction: column !important;
            align-items: center !important;
            padding: 20px !important;
            max-width: 500px !important;
            margin: 0 auto !important;
            padding-bottom: 100px !important;
        }
        #message-container h2 { color: #a267f5; margin-bottom: 20px; }
        #message-container input,
        #message-container textarea {
            width: 100% !important;
            padding: 12px !important;
            margin: 10px 0 !important;
            border: 1px solid #ccc !important;
            border-radius: 5px !important;
            font-size: 16px !important;
            font-family: Arial, sans-serif !important;
        }
        #message-container textarea {
            resize: vertical !important;
            min-height: 120px !important;
        }
        #send-button {
            padding: 12px 30px !important;
            background: #a267f5 !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 16px !important;
            margin-top: 10px !important;
        }
        #send-button:hover {
            background: #8e54d1 !important;
        }

        /* AMOR SIN VIOLENCIA */
        #amorcontainer {
            display: none !important;
            flex-direction: column !important;
            align-items: center !important;
            padding: 20px !important;
            max-width: 600px !important;
            margin: 0 auto !important;
            padding-bottom: 100px !important;
        }
        #amorcontainer h2 { color: #a267f5; margin-bottom: 20px; }
        .progress-bar {
            width: 100% !important;
            height: 20px !important;
            background: #ddd !important;
            border-radius: 10px !important;
            margin: 20px 0 !important;
            overflow: hidden !important;
        }
        #progressBarInner {
            height: 100% !important;
            background: #a267f5 !important;
            transition: width 0.3s !important;
        }
        #evaluationForm {
            width: 100% !important;
        }
        .question {
            display: none !important;
            margin-bottom: 20px !important;
            padding: 15px !important;
            background: #f5f5f5 !important;
            border-radius: 5px !important;
            border-left: 4px solid #a267f5 !important;
        }
        .question.active {
            display: block !important;
        }
        .question h3 {
            margin: 0 0 15px 0 !important;
            color: #333 !important;
        }
        .question button {
            display: block !important;
            width: 100% !important;
            padding: 12px !important;
            margin: 8px 0 !important;
            background: white !important;
            color: #a267f5 !important;
            border: 2px solid #a267f5 !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 16px !important;
            transition: all 0.3s !important;
        }
        .question button:hover {
            background: #ede9feff !important;
        }
        .question button.selected {
            background: #a267f5 !important;
            color: white !important;
        }
        #nextButton {
            padding: 12px 30px !important;
            background: #a267f5 !important;
            color: white !important;
            border: none !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            margin-top: 20px !important;
            font-size: 16px !important;
        }
        #result {
            margin-top: 20px !important;
            padding: 15px !important;
            background: #ede9feff !important;
            border-radius: 5px !important;
            text-align: center !important;
            display: none !important;
            color: #333 !important;
            border-left: 4px solid #a267f5 !important;
        }

        /* MODAL */
        #modal {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0,0,0,0.9) !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 2000 !important;
        }
        #modal img {
            max-width: 90% !important;
            max-height: 90% !important;
            border-radius: 5px !important;
        }
        #close-modal {
            position: absolute !important;
            top: 20px !important;
            right: 40px !important;
            font-size: 40px !important;
            color: white !important;
            cursor: pointer !important;
        }
    </style>
</head>
<body>
    <!-- BARRA DE INFORMACI√ìN -->
    <div id="categoria-info">
        <img id="categoria-imagen" src="logocresi.png" alt="Logo">
        <h2 id="categoria-nombre">Utilidades</h2>
        <div id="contador">
            <img src="corazon2.svg" alt="corazon" class="icocontador">
            <div id="vidas">3</div>
        </div>
        <div id="contador">
            <img src="icodiamante.svg" alt="diamante" class="icocontador">
            <div id="correctas">0</div>
        </div>
    </div>

    <!-- BUSCADOR -->
    <div id="search-container">
        <h2>üîç Buscador</h2>
        <input type="text" id="search-bar" placeholder="Buscar preguntas...">
        <button id="search-button">Buscar</button>
        <div id="search-suggestions">
            <button class="search-suggestion">Sexualidad</button>
            <button class="search-suggestion">ITS</button>
            <button class="search-suggestion">Preservativo</button>
            <button class="search-suggestion">Consentimiento</button>
            <button class="search-suggestion">Menstruaci√≥n</button>
        </div>
        <div id="search-results">
            <table id="results-table">
                <thead>
                    <tr><th>Pregunta</th></tr>
                </thead>
                <tbody id="results-body"></tbody>
            </table>
        </div>
    </div>

    <!-- INFOGRAF√çA -->
    <div id="pantallainfografia">
        <h2>üìä Infograf√≠a</h2>
        <div id="grid-container"></div>
        <div id="pagination-controls"></div>
    </div>

    <!-- CONTACTO -->
    <form action="https://formspree.io/f/xoqraayv" method="POST" id="message-container">
        <h2>‚úâÔ∏è Enviar un Mensaje</h2>
        <input type="text" id="name" name="name" placeholder="Nombre y Apellido" required>
        <input type="email" name="email" placeholder="E-mail" required>
        <input type="text" id="subject" name="text" placeholder="Asunto">
        <textarea id="message" name="message" placeholder="Mensaje" required></textarea>
        <button id="send-button" type="submit">Enviar Mensaje</button>
    </form>

    <!-- AMOR SIN VIOLENCIA -->
    <div id="amorcontainer">
        <h2>üíï Amor sin violencia</h2>
        <div class="progress-bar">
            <div id="progressBarInner"></div>
        </div>
        <form id="evaluationForm"></form>
        <button type="button" id="nextButton">Siguiente</button>
        <div id="result"></div>
    </div>

    <!-- MODAL IMAGEN -->
    <div id="modal">
        <span id="close-modal">&times;</span>
        <img id="modal-image" src="" alt="Imagen">
    </div>

    <!-- MEN√ö FLOTANTE -->
    <div id="menu">
        <div class="floating-button" id="playButton2">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M7 4v16l13 -8z" />
            </svg>
        </div>
        <div id="volado">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
                <path fill="#a267f5ff" fill-opacity="1" d="M0,160L48,133.3C96,107,192,53,288,64C384,75,480,149,576,197.3C672,245,768,267,864,272C960,277,1056,267,1152,250.7C1248,235,1344,213,1392,202.7L1440,192L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path>
            </svg>
        </div>
        <div class="menu-button" id="home-icon"><img src="home.svg" alt="home"></div>
        <div class="menu-button" id="search-icon"><img src="buscar.svg" alt="buscar"></div>
        <div class="menu-button" id="contact-icon"><img src="correo.svg" alt="correo"></div>
        <div class="menu-button" id="corazon-icon"><img src="corazon.svg" alt="amor"></div>
        <div class="menu-button" id="infografia-icon"><img src="infografia.svg" alt="infografia"></div>
        <div class="menu-button" id="trivia-icon"><img src="jugartrivia.svg" alt="trivia"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="shared-config.js"></script>
    <script src="preguntas.js"></script>
    <script>
        const photosPerPage = 9;
        let currentPageInfo = 0;
        let currentPage = 0;
        const resultsPerPage = 4;
        let currentQuestionIndexAmorViolencia = 0;
        let allResults = [];

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeUtilities);
        } else {
            initializeUtilities();
        }

        function initializeUtilities() {
            console.log('Inicializando Utilidades...');
            updateCounters();
            setupEventListeners();
            
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab') || 'search';
            const pregunta = params.get('pregunta');
            
            showTab(tab);
            
            if (pregunta) {
                document.getElementById('subject').value = pregunta;
                document.getElementById('message').value = 
                    "¬°Hola! Encontr√© un error en esta pregunta: " + pregunta + " El error que detect√© es...";
            }
        }

        function setupEventListeners() {
            // Navegaci√≥n
            document.getElementById('home-icon').addEventListener('click', () => navigateTo('index.html'));
            document.getElementById('search-icon').addEventListener('click', () => showTab('search'));
            document.getElementById('contact-icon').addEventListener('click', () => showTab('contact'));
            document.getElementById('corazon-icon').addEventListener('click', () => showTab('amor'));
            document.getElementById('infografia-icon').addEventListener('click', () => showTab('infografia'));
            document.getElementById('trivia-icon').addEventListener('click', () => navigateTo('trivia.html'));

            // Buscador
            document.getElementById('search-button').addEventListener('click', performSearch);
            document.getElementById('search-bar').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });

            // Sugerencias
            const suggestions = document.querySelectorAll('.search-suggestion');
            suggestions.forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('search-bar').value = this.textContent;
                    performSearch();
                });
            });

            // Contacto
            document.getElementById('message-container').addEventListener('submit', handleFormSubmit);

            // Modal
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });

            // Infograf√≠a
            document.getElementById('grid-container').addEventListener('click', function(e) {
                if (e.target.tagName === 'IMG') showModal(e.target.src);
            });

            // Amor sin violencia
            document.getElementById('nextButton').addEventListener('click', nextQuestion);
        }

        function updateCounters() {
            document.getElementById('vidas').textContent = vidas;
            document.getElementById('correctas').textContent = correctas;
        }

        // ===== NAVEGACI√ìN =====
        function showTab(tabName) {
            document.getElementById('search-container').style.display = 'none';
            document.getElementById('pantallainfografia').style.display = 'none';
            document.getElementById('message-container').style.display = 'none';
            document.getElementById('amorcontainer').style.display = 'none';

            switch(tabName) {
                case 'search':
                    document.getElementById('search-container').style.display = 'flex';
                    break;
                case 'infografia':
                    document.getElementById('pantallainfografia').style.display = 'flex';
                    renderGrid();
                    renderPaginationControlsInfo();
                    break;
                case 'contact':
                    document.getElementById('message-container').style.display = 'flex';
                    break;
                case 'amor':
                    document.getElementById('amorcontainer').style.display = 'flex';
                    createQuestionElements();
                    break;
            }
        }

        function navigateTo(page) {
            saveGameData();
            window.location.href = page;
        }

        // ===== BUSCADOR =====
        function performSearch() {
            const searchTerm = document.getElementById('search-bar').value;
            buscarPreguntas(searchTerm);
        }

        function buscarPreguntas(term) {
            currentPage = 0;
            const searchTerm = term.toLowerCase().trim();
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';

            if (searchTerm.length === 0) {
                document.getElementById('search-results').style.display = 'none';
                return;
            }

            allResults = preguntas.filter(p => 
                (p.pregunta && p.pregunta.toLowerCase().includes(searchTerm)) ||
                (p.respuestacorrecta && p.respuestacorrecta.toLowerCase().includes(searchTerm)) ||
                (p.masInfo && p.masInfo.toLowerCase().includes(searchTerm))
            );

            if (allResults.length > 0) {
                renderResults(allResults);
                document.getElementById('search-results').style.display = 'block';
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `<td style="text-align: center; padding: 20px;">No se encontraron resultados para "${term}"</td>`;
                resultsBody.appendChild(row);
                document.getElementById('search-results').style.display = 'block';
            }
        }

        function renderResults(results) {
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            const start = currentPage * resultsPerPage;
            const end = start + resultsPerPage;
            const paginatedResults = results.slice(start, end);

            paginatedResults.forEach((result, index) => {
                const row = document.createElement('tr');
                row.className = 'result-row';
                row.innerHTML = `<td>${result.pregunta || 'N/A'}</td>`;
                row.onclick = function() {
                    const nextRow = this.nextElementSibling;
                    if (nextRow && nextRow.querySelector('.additional-info')) {
                        const infoCell = nextRow.querySelector('.additional-info');
                        infoCell.style.display = infoCell.style.display === 'none' ? 'block' : 'none';
                    }
                };
                resultsBody.appendChild(row);

                const infoRow = document.createElement('tr');
                const infoCell = document.createElement('td');
                infoCell.colSpan = 1;
                infoCell.className = 'additional-info';
                infoCell.innerHTML = `<strong>M√°s Informaci√≥n:</strong><br>${result.masInfo || 'N/A'}`;
                infoCell.style.display = 'none';
                infoRow.appendChild(infoCell);
                resultsBody.appendChild(infoRow);
            });
        }

        // ===== INFOGRAF√çA =====
        function renderGrid() {
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = '';
            const start = currentPageInfo * photosPerPage;
            const end = start + photosPerPage;
            const paginatedPhotos = photos.slice(start, end);

            if (paginatedPhotos.length === 0) {
                gridContainer.innerHTML = '<p>No hay im√°genes disponibles</p>';
                return;
            }

            paginatedPhotos.forEach(photo => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.innerHTML = `<img src="${photo.url}" alt="${photo.description}" loading="lazy">`;
                gridContainer.appendChild(gridItem);
            });
        }

        function renderPaginationControlsInfo() {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(photos.length / photosPerPage);

            const prevButton = document.createElement('button');
            prevButton.textContent = '‚Üê Anterior';
            prevButton.disabled = currentPageInfo === 0;
            prevButton.onclick = function() {
                if (currentPageInfo > 0) {
                    currentPageInfo--;
                    renderGrid();
                    renderPaginationControlsInfo();
                }
            };
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `P√°gina ${currentPageInfo + 1} de ${totalPages}`;
            pageInfo.style.alignSelf = 'center';
            pageInfo.style.margin = '0 20px';
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Siguiente ‚Üí';
            nextButton.disabled = currentPageInfo === totalPages - 1;
            nextButton.onclick = function() {
                if (currentPageInfo < totalPages - 1) {
                    currentPageInfo++;
                    renderGrid();
                    renderPaginationControlsInfo();
                }
            };
            paginationControls.appendChild(nextButton);
        }

        // ===== CONTACTO =====
        function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            fetch(form.action, {
                method: form.method,
                body: new FormData(form),
                headers: { 'Accept': 'application/json' }
            }).then(response => {
                if (response.ok) {
                    form.reset();
                    alert("¬°Mensaje enviado con √©xito! Gracias por tu contacto.");
                } else {
                    alert("Hubo un problema al enviar el mensaje.");
                }
            }).catch(() => alert("Error al enviar el mensaje."));
        }

        // ===== AMOR SIN VIOLENCIA =====
        function createQuestionElements() {
            const form = document.getElementById('evaluationForm');
            form.innerHTML = '';
            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                if (index === 0) questionDiv.classList.add('active');

                const questionTitle = document.createElement('h3');
                questionTitle.textContent = `${index + 1}. ${question}`;
                questionDiv.appendChild(questionTitle);

                ['Si', 'A veces', 'Rara vez', 'No'].forEach(option => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.textContent = option;
                    button.onclick = () => selectOption(button, index);
                    questionDiv.appendChild(button);
                });

                form.appendChild(questionDiv);
            });
            updateProgressBar();
        }

        function selectOption(button, index) {
            const questionDiv = document.querySelectorAll('.question')[index];
            const buttons = questionDiv.querySelectorAll('button');
            buttons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }

        function nextQuestion() {
            const currentQuestionDiv = document.querySelector('.question.active');
            if (!currentQuestionDiv) return;

            const selectedButton = currentQuestionDiv.querySelector('button.selected');

            if (!selectedButton) {
                alert("Por favor, selecciona una opci√≥n antes de continuar.");
                return;
            }

            if (currentQuestionIndexAmorViolencia < questions.length - 1) {
                currentQuestionDiv.classList.remove('active');
                currentQuestionIndexAmorViolencia++;
                document.querySelectorAll('.question')[currentQuestionIndexAmorViolencia].classList.add('active');
                updateProgressBar();
            } else {
                evaluate();
                document.getElementById('nextButton').style.display = 'none';
            }
        }

        function updateProgressBar() {
            const progressBarInner = document.getElementById('progressBarInner');
            const progress = ((currentQuestionIndexAmorViolencia + 1) / questions.length) * 100;
            progressBarInner.style.width = `${progress}%`;
        }

        function evaluate() {
            let score = 0;
            document.querySelectorAll('.question').forEach((questionDiv) => {
                const selectedButton = questionDiv.querySelector('button.selected');
                if (selectedButton) {
                    const value = selectedButton.textContent;
                    if (value === 'Si') score += 3;
                    else if (value === 'A veces') score += 2;
                    else if (value === 'Rara vez') score += 1;
                }
            });

            const resultDiv = document.getElementById('result');
            let message = '';
            if (score >= 45) {
                message = '‚ö†Ô∏è Tu relaci√≥n presenta muchos signos de violencia. Es importante buscar ayuda profesional. Contacta con un especialista.';
            } else if (score >= 30) {
                message = '‚ö†Ô∏è Tu relaci√≥n tiene varios signos de violencia. Es recomendable que busques apoyo de un profesional.';
            } else if (score >= 15) {
                message = '‚ö†Ô∏è Tu relaci√≥n presenta algunos signos de violencia. Mantente alerta y considera hablar con alguien de confianza.';
            } else {
                message = '‚úÖ Tu relaci√≥n parece ser saludable. Mant√©n una comunicaci√≥n abierta y respetuosa.';
            }

            resultDiv.textContent = message;
            resultDiv.style.display = 'block';
        }

        // ===== MODAL =====
        function showModal(imageUrl) {
            document.getElementById('modal-image').src = imageUrl;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
    </script>
</body>
</html>